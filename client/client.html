<!DOCTYPE html>
<html lang="en">

<head>
    <title>The Expanse Badge Maker</title>
    <link rel="stylesheet" type="text/css" href="/style.css">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-core/5.8.34/browser.min.js"></script>
    <script type="text/babel">

        //function to parse response 
const parseResponse = (xhr,content) =>{
     //parse response (obj will be empty in a 204 updated)
     const obj = JSON.parse(xhr.response);
     console.dir(obj);
 
     //if message in response, add to screen
     if(obj.message){
         const p = document.createElement('p');
         p.textContent = `Message: ${obj.message}`;
         content.appendChild(p);
     }
    
    
    if(obj.badge){
        //grabs the canvas elements
      const canvas = document.querySelector('canvas');
      const drawCtx = canvas.getContext("2d");
        updateCanvas(obj.badge, drawCtx, canvas);
    }
};

//function to handle our response
    const handleResponse = (xhr, parse) => {
      const content = document.querySelector('#content');
    
      //check the status code
      switch(xhr.status) {
        case 200: //success
          content.innerHTML = `<b>Success</b>`;
          break;
        case 201://created
         content.innerHTML = `<b>Create</b>`;
         break;
       case 204://updated
           content.innerHTML = `<b>Updated (No Content)</b>`;
           break;
       case 400://bad request
           content.innerHTML = `<b>Bad Request</b>`;
           break;
        default: //any other status code
          content.innerHTML = `<b>Resource Not Found</b>`;
          break;
      }
        if(parse && xhr.status !== 204){     
            //parse response 
            parseResponse(xhr, content);
        }
    };

    //function to send our post request
    const sendPost = (e, form) => {
      //prevent the browser's default action (to send the form on its own)
      e.preventDefault();
      
      //grab the forms action (url to go to)
      //and method (HTTP method - POST in this case)
      const action = form.getAttribute('action');
      const method = form.getAttribute('method');
      
      //grab the form's name and age fields so we can check user input
      const name = document.querySelector('#nameField');
      const age = document.querySelector('#ageField');
      
      //create a new Ajax request (remember this is asynchronous)
      const xhr = new XMLHttpRequest();
      //set the method and url (action field from form)
      xhr.open(method, action);
        
      //this has the same format as query values        
      xhr.setRequestHeader('Content-type','application/x-www-form-urlencoded');
      //set our requested response type in hopes of a JSON response
      xhr.setRequestHeader ('Accept', 'type/json');
        
      //set our function to handle the response
      xhr.onload = () => handleResponse(xhr,true);
        
      //takes the formdata and sends it as query
      const formData = `name=${nameField.value}&age=${ageField.value}`;
      
      //send our request with the data
      xhr.send(formData);
    
      //return false to prevent the browser from trying to change page
      return false;
    };

    //function to send get requests
    //function to send our post request
    const sendGet = (e, form) => {
      //prevent the browser's default action (to send the form on its own)
      e.preventDefault();
      
      //grab the forms action (url to go to)
      //and method (HTTP method - POST in this case)
      const action = form.getAttribute('action');
      const method = form.getAttribute('method');
      
      //create a new Ajax request (remember this is asynchronous)
      const xhr = new XMLHttpRequest();
      //set the method and url (action field from form)
      xhr.open(method, action);
      
      //set our requested response type in hopes of a JSON response
      xhr.setRequestHeader ('Accept', 'application/json');
      
        console.log(method);
     if(method === 'get'){     
          //set our function to handle the response
          xhr.onload = () => handleResponse(xhr,true);
     }else{
         xhr.onload = () => handleResponse(xhr,false);
     }
        
       const preMade = document.querySelector("#Premade");
      
      //takes the formdata and sends it as query
      const formData = `key=${preMade.value}`;
        
      //send our request with the data
      xhr.send();
    
      //return false to prevent the browser from trying to change page
      return false;
    };

//takes the parsed data and updates the canvas
const updateCanvas = (obj, ctx, canvas) =>{
    ctx.fillStyle = obj.badge.color;
    ctx.fillRect(0,0,canvas.width,canvas.height);
        const frame = new Image();
        frame.src = `/media/${obj.badge.frame}.png`;
        console.log(frame);
        ctx.drawImage(frame,0,0,canvas.width,canvas.height);
};

    const init = () => {
      //grab html elements 
        //forms
      const nameForm = document.querySelector('#nameForm');
      const userForm = document.querySelector('#userForm');
        //fields for get request updates
      const preMade = document.querySelector('#Premade');
      const methodField = document.querySelector('#methodSelect');
        //submit buttons 
      const getButton = document.querySelector('#getButton');
        
        //grabs the canvas elements
      const canvas = document.querySelector('canvas');
      const drawCtx = canvas.getContext("2d");
        //draws a default canavs to show where the previes window is 
      drawCtx.fillStyle = 'black';
      drawCtx.fillRect(0,0,canvas.width,canvas.height);
      
      //create handlers 
      const getUsers = (e) => sendGet(e, userForm);
      const addUser = (e) => sendPost(e,nameForm);
      //const updatePreMade = (e) => userForm.setAttribute('action',preMade.value);
      const updateMethod = (e) => userForm.setAttribute('method',methodField.value);
        
      //attach submit event (for clicking submit or hitting enter)
      getButton.addEventListener('click', getUsers);
      nameForm.addEventListener('submit', addUser);
      //preMade.addEventListener('change',updatePreMade);
      methodField.addEventListener('change',updateMethod);
    };

    window.onload = init;


  </script>
</head>

<body>
    <section id="top">
        <h3>The Expanse Badge Maker</h3>
        <canvas id="preview" width="700" height="500"></canvas>
        <div id="controls">
            <form id="nameForm" action="/addUser" method="post">
                <label for="name">Name: </label>
                <input id="nameField" type="text" name="name" />
                <label for="age">Age: </label>
                <input id="ageField" type="number" name="age" min="0" max="100" step="1" />
                <label>Faction:</label>
                <select id="factionSelect">
                    <option value="UN">United Nations</option>
                    <option value="MCRN">Martian Congressional Republic Navy</option>
                    <option value="OPA">Outer Planet Alliance</option>
                    <option value="Protogen">Protogen Corporation</option>
                    <option value="SH">Star Helix</option>
                </select>
                <label>Sex:</label>
                <select id="factionSelect">
                    <option value="F">Female</option>
                    <option value="M">Male</option>
                </select>
                <input id="addButton" type="submit" value="Add User" />
            </form>
            <form id="userForm" action="/getUsers" method="get">
                <select id='Premade'>
                    <option value='test'>James Holden</option>
                    <option value='Naomi Nagata'>Naomi Nagata</option>
                    <option value='Alex Kamal'>Alex Kamal</option>
                    <option value='Amos Burton'>Amos Burton</option>
                </select>
                <select id="methodSelect">
                    <option value="get">GET</option>
                    <option value="head">HEAD</option>
                </select>
                <input id="getButton" type="submit" value="Get User" />
            </form>
        </div>
        <!-- Hidden Images for Displaying the Badge Frames in Canvas -->
        <image src='media/mcrn.png' style="display:none;" />
        <image src='media/un.png' style="display:none;" />
        <image src='media/opa.png' style="display:none;" />
        <image src='media/sh.png' style="display:none;" />
        <image src='media/protogen.png' style="display:none;" />
    </section>
    <section id="content">
    </section>
</body>

</html>
